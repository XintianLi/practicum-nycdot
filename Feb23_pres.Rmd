---
title: "Feb23_pres"
author: "Jiaxuan Lyu, Xintian Stella Li & Kate Sutton"
date: "2/20/2021"
output: 
  html_document:
    code_folding: hide
    toc:  true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(tidyverse)
library(ggplot2)
library(mapview)
library(RSocrata)
library(ggthemes)
library(kableExtra)
library(viridis)
library(lubridate)

setwd('C:/Users/katee/Box Sync/Practicum/shp/')

bikelane_17d<- st_read('bikelane_17d.shp')
bikelane_20d<- st_read('bikelane_20d.shp')


new_18 <- st_read('bikelane_1718Diff_2.shp')
new_19 <- st_read('bikelane_1819Diff_2.shp')
new_20 <- st_read('bikelane_1920Diff_2.shp')


boroughs<- st_read('https://data.cityofnewyork.us/resource/7t3b-ywvw.geojson')
ntas<- st_read('https://data.cityofnewyork.us/resource/q2z5-ai38.geojson')

parks<- st_read('for_basemap/geo_export_8469ffba-1951-4e52-916c-c9c4dfa54c18.shp')
big_parks<-subset(parks, parks$acres>30)

#get rid of excess columns
new_18<- new_18%>%
  select(120:242)

new_19<- new_19%>%
  select(120:241)

new_20<- new_20%>%
  select(120:244)

# add lane category
new_18$LaneType <- '3: Combination'
new_18$LaneType[new_18$BikeLane_1=='1']<- '1: Protected Lane'
new_18$LaneType[new_18$BikeLane_1=='2']<- '2: Unprotected Lane'
new_18$LaneType[new_18$BikeLane_1=='3']<- '4: Sharrow'

new_19$LaneType <- '3: Combination'
new_19$LaneType[new_19$BikeLane_1=='1']<- '1: Protected Lane'
new_19$LaneType[new_19$BikeLane_1=='2']<- '2: Unprotected Lane'
new_19$LaneType[new_19$BikeLane_1=='3']<- '4: Sharrow'

new_20$LaneType <- '3: Combination'
new_20$LaneType[new_20$BikeLane_1=='1']<- '1: Protected Lane'
new_20$LaneType[new_20$BikeLane_1=='2']<- '2: Unprotected Lane'
new_20$LaneType[new_20$BikeLane_1=='3']<- '4: Sharrow'

bikelane_17d$LaneType <- '3: Combination'
bikelane_17d$LaneType[bikelane_17d$BikeLane=='1']<- '1: Protected Lane'
bikelane_17d$LaneType[bikelane_17d$BikeLane=='2']<- '2: Unprotected Lane'
bikelane_17d$LaneType[bikelane_17d$BikeLane=='3']<- '4: Sharrow'


bikelane_20d$LaneType <- '3: Combination'
bikelane_20d$LaneType[lane2_20d$BikeLane=='1']<- '1: Protected Lane'
bikelane_20d$LaneType[lane2_20d$BikeLane=='2']<- '2: Unprotected Lane'
bikelane_20d$LaneType[lane2_20d$BikeLane=='3']<- '4: Sharrow'


#add boro name
new_18$Borough <- 'Manhattan'
new_18$Borough[new_18$LBoro_1=='2']<- 'Bronx'
new_18$Borough[new_18$LBoro_1=='3']<- 'Brooklyn'
new_18$Borough[new_18$LBoro_1=='4']<- 'Queens'
new_18$Borough[new_18$LBoro_1=='5']<- 'Staten Island'

new_19$Borough <- 'Manhattan'
new_19$Borough[new_19$LBoro_1=='2']<- 'Bronx'
new_19$Borough[new_19$LBoro_1=='3']<- 'Brooklyn'
new_19$Borough[new_19$LBoro_1=='4']<- 'Queens'
new_19$Borough[new_19$LBoro_1=='5']<- 'Staten Island'

new_20$Borough <- 'Manhattan'
new_20$Borough[new_20$LBoro_1=='2']<- 'Bronx'
new_20$Borough[new_20$LBoro_1=='3']<- 'Brooklyn'
new_20$Borough[new_20$LBoro_1=='4']<- 'Queens'
new_20$Borough[new_20$LBoro_1=='5']<- 'Staten Island'

#if sum of road <1000 ft, drop all segments with that road name
new_18_clean<- new_18%>%
  group_by(Street_1, LaneType)%>%
  summarize(Length=sum(SHAPE_Le_1),
            Borough=first(Borough))%>%
  filter(Length>1000)

new_19_clean<- new_19%>%
  group_by(Street_1, LaneType)%>%
  summarize(Length=sum(SHAPE_Le_1),
            Borough=first(Borough))%>%
  filter(Length>1000)

new_20_clean<- new_20%>%
  group_by(Street_1, LaneType)%>%
  summarize(Length=sum(SHAPE_Le_1),
            Borough=first(Borough))%>%
  filter(Length>1000)


```

```{r visfunction}
##Functions
#Plot functions
plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.2),
  axis.ticks=element_blank())

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

```


# New York City Bike Infrastructure & Cycling Patterns

### Use Case
Our client is the New York City Department of Transportation. They have shared two datasets with us
- LION: street centerlines over time
- Bike Trips: linestrings of select trips taken using NYC's bikeshare system 2018-2021

Our goal is to use these two datasets to analyze the impact of bicycle infrastructure changes on the routes chosen by cyclists over time. We will analyze bike ridership on streets that have had new bike lanes added during our study period (2018-2020) before and after the infrastructure investment. We plan to use a difference in differences approach to calculate the estimate the impact of a particular bike lane on changing ridership patterns. 


# Bike Lane Analysis

### Types of Bike Lanes
There are three main categories of bike lane in New York City's LION  data: **Protected Lanes, Unprotected Lanes,** and **Sharrows.** A fourth category, **Combination**, is comprised of street segments with a combination of the other three bike lane categories.

![Bike Lane Types in New York City](images/lanetype_table.PNG)

Unprotected bike lanes are the most common type found in New York City, while the borough of the Bronx has the highest bike lane mileage of any borough.

```{r cars}

```

## Current Lanes by Type
```{r echo=FALSE, warning=FALSE}
ggplot()+
  geom_sf(data=boroughs, color='#222222', fill='#222222')+
  geom_sf(data=big_parks, color='#4c6350', fill='#4c6350')+
  geom_sf(data=new_18_clean, aes(color = LaneType), size=0.9)+
  scale_colour_manual(values = c('#F55536','#f57f36', '#f7ac2a', '#fcd93a'))+
  labs(title='2018: New Bike Lanes by Type')
```


# Trip Data Analysis

### Data Cleaning

\
There are several steps that we have used to clean our trip data, including both cleaning data fall outside of New York City, and wrong trajectories inside of city. 
\

#### Clip Trip Data

\
There are two types of data that are fall outside of New York City. We pick trips in March5th to demonstrate how these data look like.
The first type is that there are some data located in Montreal, like the following image shows.
```{r wrongoutside, echo=FALSE, fig.cap="Wrong trajectories falling outisde of NYC-1", out.width = '80%'}
knitr::include_graphics("E:/NYCDOT/vis draft/images/type1_March5th.png")
```
\
Another type of wrong trajectories outside of NYC are trips that are connected to another country, like the following image:
```{r wrongoutside2, echo=FALSE, fig.cap="Wrong trajectories falling outisde of NYC-2", out.width = '80%'}
knitr::include_graphics("E:/NYCDOT/vis draft/images/type2_March25th.png")
```
\
In order to clean up these data, we use both clip and spatial intersection. To illustrate, the first type of data could be filtered out by clipping the trip data which are inside NYC boundary. However, for the second type of data, we find out the intersected points of trajectories with the NYC boundary, and then filter out those trips with their unique id. Due to the size of data, we import data which are already cleaned up in the later part, and provide the codes that we used to clean data.

```{r cleanoutside}
#sample code that we used to clean up data
##Get NYC data
#Reference: http://gis.ny.gov/gisdata/inventories/details.cfm?DSID=927
#NYC <- st_read("E:/NYCDOT/NYS_Civil_Boundaries_SHP/Cities_Towns.shp") %>%
  #st_transform(st_crs(March)) %>%
  #filter(NAME == "New York")

#NYC_line <- st_cast(NYC, "MULTILINESTRING")

#Marchintersect <- March[NYC_line,]

#March18_cleaned <- March[NYC, ] %>%
  #filter(! id %in% Marchintersect$id)

```
\
There are also trips inside NYC that have strange trajectories. We plan to filter out these data by using several steps.
<ol>
<li>Buffering data of bike lanes.</li>
<li>Transfer geometries of trips data from linestring to points.</li>
<li>Filter out trip data which overlay with the buffered bike lanes.</li>
<li>Gorup the points of trip data which are in the same route and have same id, which is identical to each trip.</li>
</ol>
\

#### 15 feet buffer

\
Due to the size of data and hope to keep associated attribute table, we buffer the road data in ArcGIS.
During the process of buffering, there is also trade-off:
```{r bufferchoice, echo=FALSE, fig.cap="Buffer Choice", out.width = '90%'}
knitr::include_graphics("E:/NYCDOT/vis draft/images/bufferChoice.png")
```
\
Later, we will use the buffer of bike lanes to find out overlapped trip points. However, as the figure shows, when the buffer becomes wider, there are more overlaps between bike lanes. Sometimes, the trajectories of trips do not fully overlap with the road because the road buffer is not wide enough to cover all the trips. In other words, choosing thinner buffer has potential to loss more data, but choosing thicker buffer brings problems of overlapping roads. In the consideration of this trade-off, we choose to use **15-feet** buffer for bike lanes.
\

#### Line to Point

\
Similarly, due to the size of dataset and we would like to keep associated attributes of data, we use Geoprocessing Tool, **Generate Pointes Along Lines**, in ArcGIS to transfer our geometries from linestring to points. In order to keep the progress consistent, we make the **Point Placement** by 150 meters. In other words, for one trajectory of bike trip, there will be a point by each 150-meter, including the end points.
\

#### Trips on road
\
Then we use **spatial intersect** to allocate Street Name on trip points. If the trip points are intersect with buffered lanes, they will be assigned to a Street Name.
But there is condition that one trip point will locate on several roads, at the condition when the roads are overlapped with each other at nodes.
```{r pointIntersect, echo=FALSE, fig.cap="Point on Several Roads", out.width = '90%'}
knitr::include_graphics("E:/NYCDOT/vis draft/images/pointsIntersection.png")
```
\
Like the point shown in the figure. It is located at the node where `LEXINGTON AVENUE LINE`, `EAST 77 STREET`, and `LENOX HILL HOSPITAL` are overlapped. However, the **spatial intersect** within `st_join` function only assign one road name on that point. This process is random but is acceptable because it does not assign multiple Street Name on the point.
\


### Exploratory Analysis

#### Yearly Trend

\
We would like to at first have a sense about how the trip data vary over year.
\
```{r import2018data, message=FALSE, warning=FALSE, results='hide'}
March2018 <- st_read("E:/NYCDOT/rideData_cleaned/March2018/March18_cleaned.shp")
Apr2018 <- st_read("E:/NYCDOT/rideData_cleaned/Apr2018/Apr18_cleaned.shp")
May2018 <- st_read("E:/NYCDOT/rideData_cleaned/May2018/May18_cleaned.shp")
Jun2018 <- st_read("E:/NYCDOT/rideData_cleaned/Jun2018/June18_cleaned.shp")
July2018 <- st_read("E:/NYCDOT/rideData_cleaned/July2018/July18_cleaned.shp")
Aug2018 <- st_read("E:/NYCDOT/rideData_cleaned/Aug2018/Aug18_cleaned.shp")
Sep2018 <- st_read("E:/NYCDOT/rideData_cleaned/Sep2018/Sep18_cleaned.shp")
Oct2018 <- st_read("E:/NYCDOT/rideData_cleaned/Oct2018/Oct18_cleaned.shp")
Nov2018 <- st_read("E:/NYCDOT/rideData_cleaned/Nov2018/Nov18_cleaned.shp")
Dec2018 <- st_read("E:/NYCDOT/rideData_cleaned/Dec2018/Dec18_cleaned.shp")
```

\

##### 1.Daily Trend
```{r binddata, message=FALSE, warning=FALSE, results='hide'}
dayTrend2018 <- rbind(March2018 %>% 
        as.data.frame() %>% 
        group_by(day) %>%
        tally() %>%
        mutate(month = 3), 
      Apr2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 4),
      May2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 5),
      Jun2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 6),
      July2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 7),
      Aug2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 8),
      Sep2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 9),
      Oct2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 10),
      Nov2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 11),
      Dec2018 %>%
        as.data.frame() %>%
        group_by(day) %>%
        tally() %>%
        mutate(month = 12))

```

```{r plotdayTrend, message=FALSE, warning=FALSE}
ggplot(dayTrend2018, aes(x=day, y=n, color=as.character(month))) + 
  geom_line() +
  labs(title = "Daily Trend in year 2018",
       x = "Day",
       y = "Count",
       colour="Month") +
  plotTheme +
  theme(plot.title = element_text(size=14),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12))
```

\
About the Daily Trend in 2018, there is no clear and general trend.
\

##### 2. Hourly Trend
```{r hourTrend2018, message=FALSE, warning=FALSE, paged.print=FALSE}
hourTrend2018 <- rbind(March2018 %>% 
        as.data.frame() %>% 
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 3), 
      Apr2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 4),
      May2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 5),
      Jun2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 6),
      July2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 7),
      Aug2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 8),
      Sep2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 9),
      Oct2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 10),
      Nov2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 11),
      Dec2018 %>%
        as.data.frame() %>%
        group_by(rhour) %>%
        tally() %>%
        mutate(month = 12))

```

```{r vishourTrend, message=FALSE, warning=FALSE}

ggplot(hourTrend2018, aes(x=rhour, y=n, color=as.character(month))) + 
  geom_line() +
  labs(title = "Hourly Trend in year 2018",
       x = "Hour",
       y = "Count",
       colour="Month") +
  plotTheme +
  theme(plot.title = element_text(size=14),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12))
```

\
From the Hourly Trend graph in 2018, the bike trips peak at noon and at late night.
\

##### 3.Weekday Trend
```{r wday2018, message=FALSE, warning=FALSE}

wdayTrend2018 <- rbind(March2018 %>% 
        as.data.frame() %>% 
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 3), 
      Apr2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 4),
      May2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 5),
      Jun2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 6),
      July2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 7),
      Aug2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 8),
      Sep2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 9),
      Oct2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 10),
      Nov2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 11),
      Dec2018 %>%
        as.data.frame() %>%
        mutate(wday = wday(time)) %>%
        group_by(wday) %>%
        tally() %>%
        mutate(month = 12))

```

```{r wday2018vis, message=FALSE, warning=FALSE}

ggplot(wdayTrend2018, aes(x=wday, y=n, color=as.character(month))) + 
  geom_line() +
  scale_x_continuous(breaks = seq(0, 7, by = 1)) +
  labs(title = "Weekday Trend in year 2018",
       x = "Day of Week",
       y = "Count",
       colour="Month") +
  plotTheme +
  theme(plot.title = element_text(size=14),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12))

```
\
If we view the data from the day of week, there is no clear trend about the data.
Overall, the number of trips peak at noon and at night, and the later months tend to have more trips than earlier months. There is no clear trend how the data vary among days or days of week.
\

#### Borough Level Analysis

\
Because Manhanttan as our major study hour, we also visualize the density of trips on each roads in Manhanttan, in July 2018 and July 2019.\
Due to the size of the dataset, we only choose July 22 pm as our analyzing time.Then, we narrow our data into Manhattan. Because the redundacy of process, the following part just show how we did the process but will not run the code. Later, the processed data will be directly imported.

```{r importborLane, message=FALSE, warning=FALSE, results='hide'}
#import borough Manhanttan
borough <- st_read("E:/NYCDOT/Borough Boundaries/geo_export_4c045526-dcb9-4e1a-b602-59b848e20e6a.shp") %>%
  filter(boro_name == "Manhattan") %>%
  st_transform(st_crs(July2018))
Manhatan_line <- st_cast(borough, "MULTILINESTRING")

#import bike lane data
bike15 <- st_read("E:/NYCDOT/nyclion_20d/lion_buffer15/lion_buffer15.shp") %>%
  st_transform(st_crs(July2018)) %>%
  select(Street, FeatureTyp, SegmentTyp, FaceCode, SeqNum, StreetCode, LGC1, SegmentID,
         SHAPE_Leng, SHAPE_Area, geometry)

bike15M <- bike15[borough,]

```

```{r importborData, message=FALSE, warning=FALSE, results='hide'}
##===Import data===##
#import July2018, and July2019 data
#July2018 <- st_read("E:/NYCDOT/rideData_cleaned/July2018/July18_cleaned.shp")
#July2019 <- st_read("E:/NYCDOT/rideData_cleaned/July2019/July19_cleaned.shp")


#Due to the size of dataset, only select rhour==22
#July18_22pm <- July2018 %>%
  #filter(rhour == 22)
#July19_22pm <- July2019 %>%
  #filter(rhour == 22)

##==select data only in Manhanttan==##

#find out intersection points
#July18_intersect <- July18_22pm[Manhatan_line,]
#July19_intersect <- July19_22pm[Manhatan_line,]

#only in Manhattan
#July18M_22pm <- July18_22pm[borough,] %>%
  #filter(!id %in% July18_intersect$id)
#July19M_22pm <- July19_22pm[borough,] %>%
  #filter(!id %in% July19_intersect$id)

#check
#mapview(July18M_22pm)
#mapview(July19M_22pm)



##==change trip data's geometry from linestring to points==#
#save the file
#st_write(July18M_22pm, "July18M_22pm.shp", driver = "ESRI Shapefile")
#st_write(July19M_22pm, "July19M_22pm.shp", driver = "ESRI Shapefile")

```
\

##### Visualization
```{r pnts1819, message=FALSE, warning=FALSE, results='hide'}
# import results after using ArcGIS (by 150m)
pJuly18M_22pm <- st_read("E:/NYCDOT/riderpoint_shp/July/generated/July18M_22pm_pnts.shp")
pJuly19M_22pm <- st_read("E:/NYCDOT/riderpoint_shp/July/generated/July19M_22pm_pnts.shp")


##==Select points within the roads==##
inrpnts_July18 <- pJuly18M_22pm[bike15M,]
inrpnts_July19 <- pJuly19M_22pm[bike15M,]

#allocate Street Name on roads
inrpnts_July18 <- st_join(inrpnts_July18, bike15M, join = st_intersects, left = TRUE)
inrpnts_July19 <- st_join(inrpnts_July19, bike15M, join = st_intersects, left = TRUE)

##==group points inside same street as linestring==#
#Reference:https://stackoverflow.com/questions/50908771/create-multilines-from-points-grouped-by-id-with-sf-package
pnts2Line_18 <- inrpnts_July18 %>%
  group_by(id, Street) %>%
  summarise(do_union = FALSE) %>%
  st_cast("LINESTRING")

pnts2Line_19 <- inrpnts_July19 %>%
  group_by(id, Street) %>%
  summarise(do_union = FALSE) %>%
  st_cast("LINESTRING")

#Count number of trips on each street
ntrips_July18 <- pnts2Line_18 %>%
  st_drop_geometry() %>%
  group_by(Street) %>%
  summarise(Count = n())

ntrips_July19 <- pnts2Line_19 %>%
  st_drop_geometry() %>%
  group_by(Street) %>%
  summarise(Count = n())


##==bind the trips to road table==##
road_18 <- merge(bike15M %>% select(Street, geometry), ntrips_July18, by = ("Street"), all.x=TRUE)
road_19 <- merge(bike15M %>% select(Street, geometry), ntrips_July19, by = ("Street"), all.x=TRUE)

#add year
road_18$year <- 2018
road_19$year <- 2019

```
```{r pntsVis, message=FALSE, warning=FALSE}

##==visualize==##
ggplot() +
  geom_sf(data = rbind(road_18, road_19), aes(color = Count), alpha = 0.9)+ 
  facet_wrap(~year) +
  scale_colour_viridis(direction = -1,
                       discrete = FALSE, option="viridis",
                       na.value="#D4D4D4") +
  labs(title = "Bike Trip Counts in July 22pm") +
  mapTheme()

```

\

##### Trips Comparsion on Added Bike Lanes

```{r newtripsonNewLane, message=FALSE, warning=FALSE, results='hide'}
##==Find out the number of trips on new added bike lanes==##
#import data of new bike lanes (buffer 15)
bike18new <- st_read("E:/NYCDOT/bikeDiff/bike_1718Diff/bikelane_1718DiffBuffer.shp") %>%
  st_transform(st_crs(July2018))

#clip new bike lanes in Manhanttan
bike18new_M <- bike18new[borough,]

#assign Street Name to new bike lanes
bike18new_M <- st_join(bike18new_M %>% select(-Street), bike15M %>%
                       select(Street, geometry), join = st_intersects, left = TRUE)


#Find the trip points overlap with roads
tripsinNew18 <- pJuly18M_22pm[bike18new_M,]
tripsinNew19 <- pJuly19M_22pm[bike18new_M,]

#allocate road name on pnts
newtrips18 <- st_join(tripsinNew18, bike18new_M %>% select(Street, geometry),
                      join = st_intersects, left = TRUE) %>% na.omit()

newtrips19 <- st_join(tripsinNew19, bike18new_M %>% select(Street, geometry),
                      join = st_intersects, left = TRUE) %>% na.omit()



#group points inside same street as linestring
new.pnts2Line18 <- newtrips18 %>%
  group_by(id, Street) %>%
  summarise(do_union = FALSE) %>%
  st_cast("LINESTRING")

new.pnts2Line19 <- newtrips19 %>%
  group_by(id, Street) %>%
  summarise(do_union = FALSE) %>%
  st_cast("LINESTRING")

#Count
n.new18 <- new.pnts2Line18 %>%
  st_drop_geometry() %>%
  group_by(Street) %>%
  summarise(Count = n()) %>%
  mutate(year = 2018)

n.new19 <- new.pnts2Line19 %>%
  st_drop_geometry() %>%
  group_by(Street) %>%
  summarise(Count = n()) %>%
  mutate(year = 2019)


```

```{r newDiff1819}
#Create a summarise table
#Outer join table
new.num <- merge(x = n.new18, y = n.new19, by = "Street", all = TRUE)

#assign NA to 0
new.num[is.na(new.num)] <- 0

#Find out Diff
new.num <- new.num %>%
  mutate(Diff = Count.y - Count.x)

```


```{r showtable}
new.num %>% 
  select(Street, Diff) %>% 
  kbl() %>%
  kable_styling()

```

```{r showdiffvis}
ggplot(data=new.num, aes(x=Street, y=Diff)) +
  geom_bar(stat="identity") +
  theme(
    # Remove grid lines
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # Change axis line
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank()
  ) +
  labs(title = "Trip Differences of Added Bike Lanes",
       subtitle = "Between year 2018 and year 2019 during July 22pm",
       y = "Trip Differences")

```
